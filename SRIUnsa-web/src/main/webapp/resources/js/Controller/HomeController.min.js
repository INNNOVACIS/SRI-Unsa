
investigacionApp.controller("HomeController",["$log","$scope","$location","SharedService","SRIUnsaConfig","HomeService","TipoInvestigacionService","SemestreService","TipoAsesoriaService","TipoProduccionService","EstructuraAreaInvestigacionService","FondoConcursableService","TipoInvestigadorService","ActividadesGeneradasService","PlantillaDocumentoService","FileUploader","$sce",function(X,s,O,g,j,U,H,d,x,K,M,i,I,c,D,B,e){s.sharedService=g;s.tipoInvestigaciones=[];s.estructuraOrganizaciones=[];s.semestres=[];s.loader=false;s.modal={open:false,close:true};s.mensajeSuccess=false;s.mensajeError=false;s.descripcion="";s.nombreInvestigacion="";s.totalColaboradores="0 seleccionados";s.colaboradores=[];s.submitted=false;s.tipoMonedas=["Soles","Dolares"];s.facultad={};s.departamento={};s.director={};s.facultad.snombreEstructuraOrganizacion=s.sharedService.usuarioHome[0].nombreFacultad;s.departamento.snombreEstructuraOrganizacion=s.sharedService.usuarioHome[0].nombreDepartamento;s.director.nidPersona=s.sharedService.usuarioHome[0].idPersonaDirector;s.responsable=s.sharedService.usuarioHome[0].nombre+" "+s.sharedService.usuarioHome[0].apellido;s.directores=s.sharedService.usuarioHome;s.director.snombre=s.sharedService.usuarioHome[0].nombreDirector;s.director.sapellido=s.sharedService.usuarioHome[0].apellidoDirector;console.log("USUARIOHOME :: ",s.sharedService.usuarioHome);var P=function(aa){X.debug("GetTipoInvestigaciones - Success");console.log("Respuesta :: ",aa);s.tipoInvestigaciones=aa;angular.forEach(s.tipoInvestigaciones,function(ac,ab){if(ac.nidTipoActividadInvestigacion===s.sharedService.tipoInvestigacion.nidTipoActividadInvestigacion){s.tipoInvestigacion=ac;s.changeTipoActividad(s.tipoInvestigacion.snombreActividadInvestigacion)}})};var t=function(aa){X.debug("GetTipoInvestigaciones - Error");console.log("Respuesta :: ",aa)};var G=function(aa){X.debug("GetSemestres - Success");console.log("Respuesta :: ",aa);s.semestres=aa;s.semestre=q(s.semestres)};var r=function(aa){X.debug("GetSemestres - Error");console.log("Respuesta :: ",aa)};var N=function(aa){X.debug("GetAreaInvestigaciones - Success");console.log("Respuesta :: ",aa);s.areaInvestigaciones=aa};var y=function(aa){X.debug("GetAreaInvestigaciones - Error");console.log("Respuesta :: ",aa)};var u=function(aa){X.debug("GetFondos - Success");console.log("Respuesta :: ",aa);s.fondos=aa};var w=function(aa){X.debug("GetFondos - Error");console.log("Respuesta :: ",aa)};var o=function(aa){X.debug("GetFondos - Success");console.log("Respuesta :: ",aa);s.tipoAsesorias=aa};var p=function(aa){X.debug("GetFondos - Error");console.log("Respuesta :: ",aa)};var b=function(aa){X.debug("GetTipoProducciones - Success");console.log("Respuesta :: ",aa);s.tipoProducciones=aa};var R=function(aa){X.debug("GetTipoProducciones - Error");console.log("Respuesta :: ",aa)};var k=function(aa){X.debug("RegistrarInvestigacion - Success");console.log("Respuesta :: ",aa);C(aa.body.idPlanificacion);if(S.queue.length===0){s.loader=false;s.openCloseModal(true,false)}else{S.uploadAll();n.uploadAll()}s.EnviarEmail(aa.body.actividadInvestigacion.nidActividadInvestigacion)};var T=function(aa){X.debug(aa);s.mensajeError=true;s.message=aa;s.loader=false};var a=function(aa){X.debug("EnviarEmail - Success");console.log("Respuesta :: ",aa)};var W=function(aa){X.debug("EnviarEmail - Error");console.log("Respuesta :: ",aa)};var Y=function(ab){X.debug("GetPlantillaDocumentoByFacultad - Success");console.log("Respuesta :: ",ab);s.plantillaDocumento=ab.body;s.campos="";var ad="";var aa='<div class="form-group">';var ac="</div>";angular.forEach(ab.body,function(af,ae){if((ae)%2===0){if(ad===""){ad=aa+af.splantilla}else{ad=ad+ac+aa+af.splantilla}}else{ad=ad+af.splantilla}if(af.stipo==="combobox"){h(af)}});ad=ad+ac;s.campos=e.trustAsHtml(ad)};var F=function(aa){X.debug("GetPlantillaDocumentoByFacultad - Error");console.log("Respuesta :: ",aa)};var A=function(aa){X.debug("GuardarInvestigacion - Success");console.log("Respuesta :: ",aa)};var J=function(aa){X.debug("GuardarInvestigacion - Error");console.log("Respuesta :: ",aa)};var Z=function(aa){X.debug("GetTipoInvestigador - Success");console.log("Respuesta :: ",aa);s.tipoInvestigadores=aa};var m=function(aa){X.debug("GetTipoInvestigador - Error");console.log("Respuesta :: ",aa)};s.GetTipoInvestigaciones=function(){H.getInvestigaciones().then(P,t)};s.GetSemestres=function(){d.getSemestres().then(G,r)};s.GetAreaInvestigaciones=function(){M.getAreaInvestigaciones().then(N,y)};s.GetFondos=function(){i.getFondos().then(u,w)};s.GetTipoAsesorias=function(){x.getAsesorias().then(o,p)};s.GetTipoProducciones=function(){K.getListaTipoProduccion().then(b,R)};s.GetTipoInvestigador=function(){I.GetTipoInvestigador().then(Z,m)};s.AgregarColaborador=function(){if(!v(s.colaboradores,s.persona)){s.colaboradores.push(s.persona);s.colaborador={};V()}};s.DeleteColaborador=function(ab){var aa=-1;angular.forEach(s.colaboradores,function(ad,ac){if(ad.nidPersona===ab.nidPersona){aa=ac}});s.colaboradores.splice(aa,1);V()};var h=function(aa){s[aa.sopciones]=aa.sdata.split(",")};var v=function(ab,ac){var aa=false;angular.forEach(ab,function(ae,ad){if(ae.nidPersona===ac.nidPersona){aa=true}});return aa};s.changeFacultad=function(aa){s.departamentos=[];s.escuelas=[];angular.forEach(s.estructuraOrganizaciones,function(ad,ac){if(ad.nidPadre===aa.nidEstructuraOrganizacion){s.departamentos.push(ad);s.escuelas.push(ad)}});var ab={nidEstructuraOrganizacion:aa.nidEstructuraOrganizacion,nidTipoNivel:aa.nidTipoNivel,snombreEstructuraOrganizacion:aa.snombreEstructuraOrganizacion,nidPadre:aa.nidPadre,snivel:aa.snivel};D.GetPlantillaDocumentoByFacultad(ab).then(Y,F)};s.changeArea=function(aa){s.subAreaInvestigaciones=[];angular.forEach(s.areaInvestigaciones,function(ac,ab){if(ac.nIdPadre===aa.nidEstructura){s.subAreaInvestigaciones.push(ac)}})};s.changeSubArea=function(aa){s.disciplinaInvestigaciones=[];angular.forEach(s.areaInvestigaciones,function(ac,ab){if(ac.nIdPadre===aa.nidEstructura){s.disciplinaInvestigaciones.push(ac)}})};var q=function(ac){var aa=new Date();var ab={};angular.forEach(ac,function(ae,ad){if(ae.dinicioSemestre<aa&&ae.dfinSemestre>aa){ab=ae}});return ab};s.registrarInvestigacion=function(aa){if(aa){s.loader=true;s.sharedService.scrollTop();var ab={idUsuario:s.sharedService.docente!==undefined?s.sharedService.docente.nidUsuario:s.sharedService.usuarioLogin.idUsuario,idFlujoActorOrigen:j.DOCE,idEstado:j.CREADO,idPlanificacion:-1,codigoActor:j.codeDOCE,colaboradores:s.colaboradores===undefined?[]:s.colaboradores,plantillaDocumentoActividad:l(),actividadInvestigacion:{nidResponsable:s.sharedService.docente!==undefined?s.sharedService.docente.nidPersona:s.sharedService.usuarioLogin.idPersona,nidTipoActividadInvestigacion:s.tipoInvestigacion.nidTipoActividadInvestigacion,nhoras:s.duracionInvestigacion,sritipoProduccion:s.tipoProduccion===undefined?"":s.tipoProduccion.snombreTipoProduccion,sfondoConcursable:s.fondo===undefined?"":s.fondo.snombreFondoConcursable,stipoAsesoria:s.tipoAsesoria===undefined?"":s.tipoAsesoria.snombreTipoAsesoria,ssemestre:s.semestre.snombreSemestre,sfacultad:s.facultad.snombreEstructuraOrganizacion,sescuela:s.escuela===undefined?"":s.escuela.snombreEstructuraOrganizacion,sdepartamento:s.departamento.snombreEstructuraOrganizacion,sareaInvestigacion:s.areaInvestigacion===undefined?"":s.areaInvestigacion.sNombre,ssubAreaInvestigacion:s.subAreaInvestigacion===undefined?"":s.subAreaInvestigacion.sNombre,sdisciplina:s.disciplinaInvestigacion.sNombre,stipoLabor:s.tipoLabor===undefined?"":s.tipoLabor.nombre,snombreActividadInvestigacion:s.nombreInvestigacion,dfechaRegistro:s.fechaRegistro,dfechaAceptacion:s.fechaAceptacion,dfechaFin:s.fechaFin,sdescripcionActividad:s.descripcion,nidDirector:s.director.nidPersona,snombreAsesorado:s.nombreAsesorado,slineaInvestigacion:s.lineaInvestigacion,snombreCurso:s.nombreCurso,snumeroContrato:s.numeroContrato,snombrePublicacion:s.nombrePublicacion,scodigo:s.codigo,splazoEjecucion:s.plazoEjecucion,suserCreacion:s.sharedService.nombreUsuario,suserModificacion:s.sharedService.nombreUsuario,sestado:"A"}};U.registrarInvestigacion(ab).then(k,T)}else{s.sharedService.scrollTop();s.submitted=true;angular.forEach(s.plantillaDocumento,function(ad,ac){console.log(s[ad.smodel])});console.log("campos por validar")}};s.guardarInvestigacion=function(aa){s.sharedService.scrollTop();var ab={idUsuario:s.sharedService.idUsuario,idFlujoActorOrigen:j.DOCE,idEstado:j.PREVIO,idPlanificacion:-1,codigoActor:j.codeDOCE,colaboradores:s.colaboradores===undefined?[]:s.colaboradores,plantillaDocumentoActividad:l(),actividadInvestigacion:{nidResponsable:s.responsable.nidPersona,nidTipoActividadInvestigacion:s.tipoInvestigacion.nidTipoActividadInvestigacion,nhoras:s.duracionInvestigacion,sritipoProduccion:s.tipoProduccion===undefined?"":s.tipoProduccion.snombreTipoProduccion,sfondoConcursable:s.fondo===undefined?"":s.fondo.snombreFondoConcursable,stipoAsesoria:s.tipoAsesoria===undefined?"":s.tipoAsesoria.snombreTipoAsesoria,ssemestre:s.semestre===undefined?"":s.semestre.snombreSemestre,sfacultad:s.facultad===undefined?"":s.facultad.snombreEstructuraOrganizacion,sescuela:s.escuela===undefined?"":s.escuela.snombreEstructuraOrganizacion,sdepartamento:s.departamento===undefined?"":s.departamento.snombreEstructuraOrganizacion,sareaInvestigacion:s.areaInvestigacion===undefined?"":s.areaInvestigacion.sNombre,ssubAreaInvestigacion:s.subAreaInvestigacion===undefined?"":s.subAreaInvestigacion.sNombre,sdisciplina:s.disciplinaInvestigacion===undefined?"":s.disciplinaInvestigacion.sNombre,stipoLabor:s.tipoLabor===undefined?"":s.tipoLabor.nombre,snombreActividadInvestigacion:s.nombreInvestigacion,navance:s.avance,dfechaRegistro:s.fechaRegistro,dfechaInicio:s.fechaInicio,dfechaFin:s.fechaFin,sdescripcionActividad:s.descripcion,suserCreacion:s.sharedService.nombreUsuario,sestado:"A"}};console.log("GuardarActividadInvestigacion :: ",ab);U.GuardarInvestigacion(ab).then(A,J)};var l=function(){var aa=[];angular.forEach(s.plantillaDocumento,function(ad,ab){var ac={nidPlantillaDocumento:ad.nidPlantillaDocumento,svalor:s[ad.smodel]};aa.push(ac)});return aa};s.EnviarEmail=function(aa){var ab={idUsuario:s.sharedService.idUsuario,idFlujoActorOrigen:j.DOCE,idEstado:j.CREADO,idPlanificacion:-1,codigoActor:j.codeDOCE,colaboradores:[],plantillaDocumentoActividad:[],actividadInvestigacion:{nidActividadInvestigacion:aa}};c.EnviarEmail(ab).then(a,W)};s.GetTipoInvestigaciones();s.GetSemestres();s.GetAreaInvestigaciones();s.GetFondos();s.GetTipoAsesorias();s.GetTipoProducciones();s.GetTipoInvestigador();s.changeTipoActividad=function(aa){s.mostrarActividad=[false,false,false,false];switch(aa.toUpperCase()){case"INVESTIGACION FORMATIVA":s.mostrarActividad=[true,false,false,false];s.descripcionLabel="Breve descripcion de la Actividad Formativa";s.tituloLabel="Nombre del curso o Asignatura";s.adjuntar="Adjuntar Sílabo del Curso";s.adjuntarOtros="Adjuntar Resultados de Investigación";s.showDescripcion=true;break;case"ASESORIA DE TESIS":s.mostrarActividad=[false,true,false,false];s.descripcionLabel="Resumen de Tesis";s.tituloLabel="Titulo de Tesis";s.adjuntar="Adjuntar Resolución";s.adjuntarOtros="Otros Medios (Plan de Tesis, Avances, Otros)";s.showDescripcion=false;break;case"INVESTIGACIONES BASICAS Y APLICADAS":s.mostrarActividad=[false,false,true,false];s.descripcionLabel="Resumen de Investigacion";s.tituloLabel="Titulo del Proyecto de Investigacion";s.adjuntar="Adjuntar Contrato";s.adjuntarOtros="Adjuntar Ficha de Postulación";s.showDescripcion=true;break;case"PRODUCCION INTELECTUAL":s.mostrarActividad=[false,false,false,true];s.descripcionLabel="Resumen";s.tituloLabel="Título";s.adjuntar="Adjuntar Planificación";s.adjuntarOtros="Adjuntar Libro o Artículo (Opcional)";s.showDescripcion=false;break;default:s.mostrarActividad=[false,false,false,false];s.descripcionLabel="Resumen";s.tituloLabel="Nombre";s.adjuntar="Adjuntar";s.adjuntarOtros="Adjuntar Otros";s.showDescripcion=true}};s.registrarNuevaActividad=function(){f();s.openCloseModal(false,true)};s.irActividadesGeneradas=function(){s.loader=true;O.path("/actividad/Generadas")};s.changeTipoProduccion=function(aa){s.showVerificacion=true;if(aa.snombreTipoProduccion.toUpperCase()==="ARTICULO"){s.fechaTipoProduccion="Fecha de Aceptacion";s.labelCodigo="DOI";s.labelNombrePublicacion="Nombre de la Revista"}else{s.fechaTipoProduccion="Fecha de Publicacion";s.labelCodigo="ISBN";s.labelNombrePublicacion="Nombre de la Editorial"}};var V=function(){var aa=s.colaboradores===undefined?0:s.colaboradores.length;s.totalColaboradores=aa+" seleccionados"};s.openCloseModal=function(aa,ab){s.modal={open:aa,close:ab}};var f=function(){s.duracionInvestigacion=0;s.tipoProduccion={};s.fondo={};s.tipoAsesoria={};s.escuela={};s.areaInvestigacion={};s.subAreaInvestigacion={};s.disciplinaInvestigacion={};s.tipoLabor={};s.nombreInvestigacion=" ";s.descripcion="";s.campos="";s.lineaInvestigacion="";s.colaboradores=[];s.colaborador={};s.fechaInicio="";s.fechaFin="";s.avance="";s.submitted=false;s.nombreAsesorado="";s.cuiAsesorado="";s.lineaInvestigacion="";s.nombreCurso="";s.numeroContrato="";s.montoFinanciamiento="";S.clearQueue();n.clearQueue()};s.files=[];var S=s.uploader=new B({url:j.SRIUnsaUrlServicio+"/files/subirArchivos"});var n=s.uploader2=new B({url:j.SRIUnsaUrlServicio+"/files/subirArchivos"});var E=function(aa){X.debug(aa)};var Q=function(aa){X.debug(aa)};s.uploadFile=function(){var aa=s.archivo;var ab=new FormData();ab.append("file",aa);U.sendFile(ab,true).then(E,Q)};S.filters.push({name:"customFilter",fn:function(ab,aa){return this.queue.length<10}});n.filters.push({name:"customFilter2",fn:function(ab,aa){return this.queue.length<10}});var C=function(aa){angular.forEach(S.queue,function(ac,ab){console.log(ac.file.name);ac.formData.push({idPlanificacion:aa})});angular.forEach(n.queue,function(ac,ab){console.log(ac.file.name);ac.formData.push({idPlanificacion:aa})})};S.onWhenAddingFileFailed=function(ac,ab,aa){};S.onAfterAddingFile=function(aa){};S.onAfterAddingAll=function(aa){};S.onBeforeUploadItem=function(aa){};S.onProgressItem=function(aa,ab){};S.onProgressAll=function(aa){console.info("onProgressAll",aa)};S.onSuccessItem=function(ac,ab,aa,ad){};S.onErrorItem=function(ac,ab,aa,ad){};S.onCancelItem=function(ac,ab,aa,ad){};S.onCompleteItem=function(ac,ab,aa,ad){};S.onCompleteAll=function(){console.info("onCompleteAll");s.loader=false;s.openCloseModal(true,false)};s.today=function(){s.fechaRegistro=new Date()};s.today();s.inlineOptions={customClass:z,minDate:new Date()};s.dateOptions={dateDisabled:L,formatYear:"yy",maxDate:new Date(2020,5,22),minDate:new Date(),startingDay:1,showWeeks:false,showButtonBar:false};function L(ab){var aa=ab.date,ac=ab.mode;return ac==="day"&&(aa.getDay()===0||aa.getDay()===6)}s.toggleMin=function(){s.inlineOptions.minDate=s.inlineOptions.minDate?null:new Date();s.dateOptions.minDate=s.inlineOptions.minDate};s.toggleMin();s.openAceptacion=function(){s.popupAceptacion.opened=true};s.openFin=function(){s.popupFin.opened=true};s.openRegistro=function(){s.popupRegistro.opened=true};s.setDate=function(ab,ac,aa){s.dtRegistro=new Date(ab,ac,aa)};s.formats=["dd/MMMM/yyyy","yyyy/MM/dd","dd.MM.yyyy","shortDate"];s.format=s.formats[0];s.altInputFormats=["M!/d!/yyyy"];s.popupAceptacion={opened:false};s.popupFin={opened:false};s.popupRegistro={opened:false};function z(ae){var aa=ae.date;var af=ae.mode;if(af==="day"){var ac=new Date(aa).setHours(0,0,0,0);for(var ab=0;ab<s.events.length;ab++){var ad=new Date(s.events[ab].date).setHours(0,0,0,0);if(ac===ad){return s.events[ab].status}}}return""}}]);