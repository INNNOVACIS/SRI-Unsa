
investigacionApp.controller("HomeController",["$log","$scope","$location","SharedService","SRIUnsaConfig","HomeService","TipoInvestigacionService","SemestreService","TipoAsesoriaService","TipoProduccionService","EstructuraAreaInvestigacionService","FondoConcursableService","TipoNivelService","EstructuraOrganizacionService","ActividadesGeneradasService","PlantillaDocumentoService","FileUploader","$sce",function(X,s,O,h,k,U,I,e,x,K,M,j,y,c,d,E,C,f){s.sharedService=h;s.tipoInvestigaciones=[];s.estructuraOrganizaciones=[];s.semestres=[];s.loader=false;s.modal={open:false,close:true};s.mensajeSuccess=false;s.mensajeError=false;s.descripcion="";s.nombreInvestigacion="";s.totalColaboradores="0 seleccionados";s.colaboradores=[];s.submitted=false;s.tipoMonedas=["Soles","Dolares"];s.facultad={};s.departamento={};s.director={};s.facultad.snombreEstructuraOrganizacion=s.sharedService.usuarioHome[0].nombreFacultad;s.departamento.snombreEstructuraOrganizacion=s.sharedService.usuarioHome[0].nombreDepartamento;s.director.nidPersona=s.sharedService.usuarioHome[0].idPersonaDirector;s.responsable=s.sharedService.usuarioHome[0].nombre+" "+s.sharedService.usuarioHome[0].apellido;s.directores=s.sharedService.usuarioHome;s.director.snombre=s.sharedService.usuarioHome[0].nombreDirector;s.director.sapellido=s.sharedService.usuarioHome[0].apellidoDirector;console.log("USUARIOHOME :: ",s.sharedService.usuarioHome);var P=function(Z){X.debug("GetTipoInvestigaciones - Success");console.log("Respuesta :: ",Z);s.tipoInvestigaciones=Z;angular.forEach(s.tipoInvestigaciones,function(ab,aa){if(ab.nidTipoActividadInvestigacion===s.sharedService.tipoInvestigacion.nidTipoActividadInvestigacion){s.tipoInvestigacion=ab;s.changeTipoActividad(s.tipoInvestigacion.snombreActividadInvestigacion)}})};var t=function(Z){X.debug("GetTipoInvestigaciones - Error");console.log("Respuesta :: ",Z)};var H=function(Z){X.debug("GetSemestres - Success");console.log("Respuesta :: ",Z);s.semestres=Z;s.semestre=q(s.semestres)};var r=function(Z){X.debug("GetSemestres - Error");console.log("Respuesta :: ",Z)};var N=function(Z){X.debug("GetAreaInvestigaciones - Success");console.log("Respuesta :: ",Z);s.areaInvestigaciones=Z};var z=function(Z){X.debug("GetAreaInvestigaciones - Error");console.log("Respuesta :: ",Z)};var u=function(Z){X.debug("GetFondos - Success");console.log("Respuesta :: ",Z);s.fondos=Z};var w=function(Z){X.debug("GetFondos - Error");console.log("Respuesta :: ",Z)};var o=function(Z){X.debug("GetFondos - Success");console.log("Respuesta :: ",Z);s.tipoAsesorias=Z};var p=function(Z){X.debug("GetFondos - Error");console.log("Respuesta :: ",Z)};var b=function(Z){X.debug("GetTipoProducciones - Success");console.log("Respuesta :: ",Z);s.tipoProducciones=Z};var R=function(Z){X.debug("GetTipoProducciones - Error");console.log("Respuesta :: ",Z)};var l=function(Z){X.debug("RegistrarInvestigacion - Success");console.log("Respuesta :: ",Z);D(Z.body.idPlanificacion);if(S.queue.length===0){s.loader=false;s.openCloseModal(true,false)}else{S.uploadAll();n.uploadAll()}s.EnviarEmail(Z.body.actividadInvestigacion.nidActividadInvestigacion)};var T=function(Z){X.debug(Z);s.mensajeError=true;s.message=Z;s.loader=false};var a=function(Z){X.debug("EnviarEmail - Success");console.log("Respuesta :: ",Z)};var W=function(Z){X.debug("EnviarEmail - Error");console.log("Respuesta :: ",Z)};var Y=function(aa){X.debug("GetPlantillaDocumentoByFacultad - Success");console.log("Respuesta :: ",aa);s.plantillaDocumento=aa.body;s.campos="";var ac="";var Z='<div class="form-group">';var ab="</div>";angular.forEach(aa.body,function(ae,ad){if((ad)%2===0){if(ac===""){ac=Z+ae.splantilla}else{ac=ac+ab+Z+ae.splantilla}}else{ac=ac+ae.splantilla}if(ae.stipo==="combobox"){i(ae)}});ac=ac+ab;s.campos=f.trustAsHtml(ac)};var G=function(Z){X.debug("GetPlantillaDocumentoByFacultad - Error");console.log("Respuesta :: ",Z)};var B=function(Z){X.debug("GuardarInvestigacion - Success");console.log("Respuesta :: ",Z)};var J=function(Z){X.debug("GuardarInvestigacion - Error");console.log("Respuesta :: ",Z)};s.GetTipoInvestigaciones=function(){I.getInvestigaciones().then(P,t)};s.GetSemestres=function(){e.getSemestres().then(H,r)};s.GetAreaInvestigaciones=function(){M.getAreaInvestigaciones().then(N,z)};s.GetFondos=function(){j.getFondos().then(u,w)};s.GetTipoAsesorias=function(){x.getAsesorias().then(o,p)};s.GetTipoProducciones=function(){K.getListaTipoProduccion().then(b,R)};s.AgregarColaborador=function(){if(!v(s.colaboradores,s.persona)){s.colaboradores.push(s.persona);s.colaborador={};V()}};s.DeleteColaborador=function(aa){var Z=-1;angular.forEach(s.colaboradores,function(ac,ab){if(ac.nidPersona===aa.nidPersona){Z=ab}});s.colaboradores.splice(Z,1);V()};var i=function(Z){s[Z.sopciones]=Z.sdata.split(",")};var v=function(aa,ab){var Z=false;angular.forEach(aa,function(ad,ac){if(ad.nidPersona===ab.nidPersona){Z=true}});return Z};s.changeFacultad=function(Z){s.departamentos=[];s.escuelas=[];angular.forEach(s.estructuraOrganizaciones,function(ac,ab){if(ac.nidPadre===Z.nidEstructuraOrganizacion){s.departamentos.push(ac);s.escuelas.push(ac)}});var aa={nidEstructuraOrganizacion:Z.nidEstructuraOrganizacion,nidTipoNivel:Z.nidTipoNivel,snombreEstructuraOrganizacion:Z.snombreEstructuraOrganizacion,nidPadre:Z.nidPadre,snivel:Z.snivel};E.GetPlantillaDocumentoByFacultad(aa).then(Y,G)};s.changeArea=function(Z){s.subAreaInvestigaciones=[];angular.forEach(s.areaInvestigaciones,function(ab,aa){if(ab.nIdPadre===Z.nidEstructura){s.subAreaInvestigaciones.push(ab)}})};s.changeSubArea=function(Z){s.disciplinaInvestigaciones=[];angular.forEach(s.areaInvestigaciones,function(ab,aa){if(ab.nIdPadre===Z.nidEstructura){s.disciplinaInvestigaciones.push(ab)}})};var q=function(ab){var Z=new Date();var aa={};angular.forEach(ab,function(ad,ac){if(ad.dinicioSemestre<Z&&ad.dfinSemestre>Z){aa=ad}});return aa};s.registrarInvestigacion=function(Z){if(Z){s.loader=true;s.sharedService.scrollTop();var aa={idUsuario:s.sharedService.docente!==undefined?s.sharedService.docente.nidUsuario:s.sharedService.usuarioLogin.idUsuario,idFlujoActorOrigen:k.DOCE,idEstado:k.CREADO,idPlanificacion:-1,codigoActor:k.codeDOCE,colaboradores:s.colaboradores===undefined?[]:s.colaboradores,plantillaDocumentoActividad:m(),actividadInvestigacion:{nidResponsable:s.sharedService.docente!==undefined?s.sharedService.docente.nidPersona:s.sharedService.usuarioLogin.idPersona,nidTipoActividadInvestigacion:s.tipoInvestigacion.nidTipoActividadInvestigacion,nhoras:s.duracionInvestigacion,sritipoProduccion:s.tipoProduccion===undefined?"":s.tipoProduccion.snombreTipoProduccion,sfondoConcursable:s.fondo===undefined?"":s.fondo.snombreFondoConcursable,stipoAsesoria:s.tipoAsesoria===undefined?"":s.tipoAsesoria.snombreTipoAsesoria,ssemestre:s.semestre.snombreSemestre,sfacultad:s.facultad.snombreEstructuraOrganizacion,sescuela:s.escuela===undefined?"":s.escuela.snombreEstructuraOrganizacion,sdepartamento:s.departamento.snombreEstructuraOrganizacion,sareaInvestigacion:s.areaInvestigacion===undefined?"":s.areaInvestigacion.sNombre,ssubAreaInvestigacion:s.subAreaInvestigacion===undefined?"":s.subAreaInvestigacion.sNombre,sdisciplina:s.disciplinaInvestigacion.sNombre,stipoLabor:s.tipoLabor===undefined?"":s.tipoLabor.nombre,snombreActividadInvestigacion:s.nombreInvestigacion,dfechaRegistro:s.fechaRegistro,dfechaAceptacion:s.fechaAceptacion,dfechaFin:s.fechaFin,sdescripcionActividad:s.descripcion,nidDirector:s.director.nidPersona,snombreAsesorado:s.nombreAsesorado,slineaInvestigacion:s.lineaInvestigacion,snombreCurso:s.nombreCurso,snumeroContrato:s.numeroContrato,snombrePublicacion:s.nombrePublicacion,scodigo:s.codigo,splazoEjecucion:s.plazoEjecucion,suserCreacion:s.sharedService.nombreUsuario,suserModificacion:s.sharedService.nombreUsuario,sestado:"A"}};U.registrarInvestigacion(aa).then(l,T)}else{s.sharedService.scrollTop();s.submitted=true;angular.forEach(s.plantillaDocumento,function(ac,ab){console.log(s[ac.smodel])});console.log("campos por validar")}};s.guardarInvestigacion=function(Z){s.sharedService.scrollTop();var aa={idUsuario:s.sharedService.idUsuario,idFlujoActorOrigen:k.DOCE,idEstado:k.PREVIO,idPlanificacion:-1,codigoActor:k.codeDOCE,colaboradores:s.colaboradores===undefined?[]:s.colaboradores,plantillaDocumentoActividad:m(),actividadInvestigacion:{nidResponsable:s.responsable.nidPersona,nidTipoActividadInvestigacion:s.tipoInvestigacion.nidTipoActividadInvestigacion,nhoras:s.duracionInvestigacion,sritipoProduccion:s.tipoProduccion===undefined?"":s.tipoProduccion.snombreTipoProduccion,sfondoConcursable:s.fondo===undefined?"":s.fondo.snombreFondoConcursable,stipoAsesoria:s.tipoAsesoria===undefined?"":s.tipoAsesoria.snombreTipoAsesoria,ssemestre:s.semestre===undefined?"":s.semestre.snombreSemestre,sfacultad:s.facultad===undefined?"":s.facultad.snombreEstructuraOrganizacion,sescuela:s.escuela===undefined?"":s.escuela.snombreEstructuraOrganizacion,sdepartamento:s.departamento===undefined?"":s.departamento.snombreEstructuraOrganizacion,sareaInvestigacion:s.areaInvestigacion===undefined?"":s.areaInvestigacion.sNombre,ssubAreaInvestigacion:s.subAreaInvestigacion===undefined?"":s.subAreaInvestigacion.sNombre,sdisciplina:s.disciplinaInvestigacion===undefined?"":s.disciplinaInvestigacion.sNombre,stipoLabor:s.tipoLabor===undefined?"":s.tipoLabor.nombre,snombreActividadInvestigacion:s.nombreInvestigacion,navance:s.avance,dfechaRegistro:s.fechaRegistro,dfechaInicio:s.fechaInicio,dfechaFin:s.fechaFin,sdescripcionActividad:s.descripcion,suserCreacion:s.sharedService.nombreUsuario,sestado:"A"}};console.log("GuardarActividadInvestigacion :: ",aa);U.GuardarInvestigacion(aa).then(B,J)};var m=function(){var Z=[];angular.forEach(s.plantillaDocumento,function(ac,aa){var ab={nidPlantillaDocumento:ac.nidPlantillaDocumento,svalor:s[ac.smodel]};Z.push(ab)});return Z};s.EnviarEmail=function(Z){var aa={idUsuario:s.sharedService.idUsuario,idFlujoActorOrigen:k.DOCE,idEstado:k.CREADO,idPlanificacion:-1,codigoActor:k.codeDOCE,colaboradores:[],plantillaDocumentoActividad:[],actividadInvestigacion:{nidActividadInvestigacion:Z}};d.EnviarEmail(aa).then(a,W)};s.GetTipoInvestigaciones();s.GetSemestres();s.GetAreaInvestigaciones();s.GetFondos();s.GetTipoAsesorias();s.GetTipoProducciones();s.changeTipoActividad=function(Z){s.mostrarActividad=[false,false,false,false];switch(Z.toUpperCase()){case"INVESTIGACION FORMATIVA":s.mostrarActividad=[true,false,false,false];s.descripcionLabel="Breve descripcion de la Actividad Formativa";s.tituloLabel="Nombre del curso o Asignatura";s.adjuntar="Adjuntar Sílabo del Curso";s.adjuntarOtros="Adjuntar Resultados de Investigación";s.showDescripcion=true;break;case"ASESORIA DE TESIS":s.mostrarActividad=[false,true,false,false];s.descripcionLabel="Resumen de Tesis";s.tituloLabel="Titulo de Tesis";s.adjuntar="Adjuntar Resolución";s.adjuntarOtros="Otros Medios (Plan de Tesis, Avances, Otros)";s.showDescripcion=false;break;case"INVESTIGACIONES BASICAS Y APLICADAS":s.mostrarActividad=[false,false,true,false];s.descripcionLabel="Resumen de Investigacion";s.tituloLabel="Titulo del Proyecto de Investigacion";s.adjuntar="Adjuntar Contrato";s.adjuntarOtros="Adjuntar Ficha de Postulación";s.showDescripcion=true;break;case"PRODUCCION INTELECTUAL":s.mostrarActividad=[false,false,false,true];s.descripcionLabel="Resumen";s.tituloLabel="Título";s.adjuntar="Adjuntar Planificación";s.adjuntarOtros="Adjuntar Libro o Artículo (Opcional)";s.showDescripcion=false;break;default:s.mostrarActividad=[false,false,false,false];s.descripcionLabel="Resumen";s.tituloLabel="Nombre";s.adjuntar="Adjuntar";s.adjuntarOtros="Adjuntar Otros";s.showDescripcion=true}};s.registrarNuevaActividad=function(){g();s.openCloseModal(false,true)};s.irActividadesGeneradas=function(){s.loader=true;O.path("/actividad/Generadas")};s.changeTipoProduccion=function(Z){s.showVerificacion=true;if(Z.snombreTipoProduccion.toUpperCase()==="ARTICULO"){s.fechaTipoProduccion="Fecha de Aceptacion";s.labelCodigo="DOI";s.labelNombrePublicacion="Nombre de la Revista"}else{s.fechaTipoProduccion="Fecha de Publicacion";s.labelCodigo="ISBN";s.labelNombrePublicacion="Nombre de la Editorial"}};var V=function(){var Z=s.colaboradores===undefined?0:s.colaboradores.length;s.totalColaboradores=Z+" seleccionados"};s.openCloseModal=function(Z,aa){s.modal={open:Z,close:aa}};var g=function(){s.duracionInvestigacion=0;s.tipoProduccion={};s.fondo={};s.tipoAsesoria={};s.semestre={};s.escuela={};s.areaInvestigacion={};s.subAreaInvestigacion={};s.disciplinaInvestigacion={};s.tipoLabor={};s.nombreInvestigacion=" ";s.descripcion="";s.campos="";s.lineaInvestigacion="";s.colaboradores=[];s.colaborador={};s.fechaInicio="";s.fechaFin="";s.avance="";s.submitted=false;s.nombreAsesorado="";s.cuiAsesorado="";s.lineaInvestigacion="";s.nombreCurso="";s.numeroContrato="";s.montoFinanciamiento="";S.clearQueue();n.clearQueue()};s.files=[];var S=s.uploader=new C({url:k.SRIUnsaUrlServicio+"/files/subirArchivos"});var n=s.uploader2=new C({url:k.SRIUnsaUrlServicio+"/files/subirArchivos"});var F=function(Z){X.debug(Z)};var Q=function(Z){X.debug(Z)};s.uploadFile=function(){var Z=s.archivo;var aa=new FormData();aa.append("file",Z);U.sendFile(aa,true).then(F,Q)};S.filters.push({name:"customFilter",fn:function(aa,Z){return this.queue.length<10}});n.filters.push({name:"customFilter2",fn:function(aa,Z){return this.queue.length<10}});var D=function(Z){angular.forEach(S.queue,function(ab,aa){console.log(ab.file.name);ab.formData.push({idPlanificacion:Z})});angular.forEach(n.queue,function(ab,aa){console.log(ab.file.name);ab.formData.push({idPlanificacion:Z})})};S.onWhenAddingFileFailed=function(ab,aa,Z){};S.onAfterAddingFile=function(Z){};S.onAfterAddingAll=function(Z){};S.onBeforeUploadItem=function(Z){};S.onProgressItem=function(Z,aa){};S.onProgressAll=function(Z){console.info("onProgressAll",Z)};S.onSuccessItem=function(ab,aa,Z,ac){};S.onErrorItem=function(ab,aa,Z,ac){};S.onCancelItem=function(ab,aa,Z,ac){};S.onCompleteItem=function(ab,aa,Z,ac){};S.onCompleteAll=function(){console.info("onCompleteAll");s.loader=false;s.openCloseModal(true,false)};s.today=function(){s.fechaRegistro=new Date()};s.today();s.inlineOptions={customClass:A,minDate:new Date()};s.dateOptions={dateDisabled:L,formatYear:"yy",maxDate:new Date(2020,5,22),minDate:new Date(),startingDay:1,showWeeks:false,showButtonBar:false};function L(aa){var Z=aa.date,ab=aa.mode;return ab==="day"&&(Z.getDay()===0||Z.getDay()===6)}s.toggleMin=function(){s.inlineOptions.minDate=s.inlineOptions.minDate?null:new Date();s.dateOptions.minDate=s.inlineOptions.minDate};s.toggleMin();s.openAceptacion=function(){s.popupAceptacion.opened=true};s.openFin=function(){s.popupFin.opened=true};s.openRegistro=function(){s.popupRegistro.opened=true};s.setDate=function(aa,ab,Z){s.dtRegistro=new Date(aa,ab,Z)};s.formats=["dd/MMMM/yyyy","yyyy/MM/dd","dd.MM.yyyy","shortDate"];s.format=s.formats[0];s.altInputFormats=["M!/d!/yyyy"];s.popupAceptacion={opened:false};s.popupFin={opened:false};s.popupRegistro={opened:false};function A(ad){var Z=ad.date;var ae=ad.mode;if(ae==="day"){var ab=new Date(Z).setHours(0,0,0,0);for(var aa=0;aa<s.events.length;aa++){var ac=new Date(s.events[aa].date).setHours(0,0,0,0);if(ab===ac){return s.events[aa].status}}}return""}}]);